## Redis · 最佳实践 · 阿里云Redis助力双11业务


双11如火如荼的结束了，阿里云Redis(ApsaraDB for Redis原KVStore)也圆满完成了双11Redis的保障工作。目前阿里云Redis提供了单机版本和集群版本的Redis。  


* 单机版本Redis具有很高的兼容性，并且支持Lua脚本及地理位置计算。
* 集群版本具有大容量、高性能的特性，能够突破Redis单线程的单机性能极限。



阿里云Redis默认双机热备并提供了备份恢复支持，同时阿里云Redis源码团队持续对Redis进行优化升级，提供了强大的安全防护能力。本文将选取双11的一些业务场景简化之后进行介绍，实际业务场景会比本文复杂。  

## 微淘社区之亿级关系链存储

微淘社区承载了亿级淘宝用户的社交关系链，对于每个用户都有自己的关注列表，每个商家有自己的粉丝信息，整个微淘社区承载的关系链如下图所示。  


![][0]  


如果选用传统的关系型数据库模型表达如上的关系信息，会使业务设计繁杂，并且不能获得良好的性能体验。微淘社区使用Redis集群缓存了存储社区的关注链，简化了关注信息的存储，并保证了双11业务丝滑一般的体验。微淘社区使用了Hashes存储用户之间的关注信息，存储结构如下，并提供了以下两种的查询接口：  


* 用户A 是否和 用户B产生过关注关系；
* 用户A的主动关系列表；



![][1]  

## 天猫直播之评论商品游标分页

双11用户在观看无线端直播的时候，需要对直播对应的评论进行刷新动作，主要有以下三种模式:  


* 增量下拉。 也即是从指定位置向上获取指定个数（增量）的评论。
* 下拉刷新。 也即是获取最新的指定个数的评论。
* 增量上拉。 也即是从指定位置向下获取指定个数（增量）的评论。



无线直播系统使用Redis优化该场景的业务，保证了直播评论接口的成功率，并能够保证5w+以上的tps和毫秒级的rt请求。直播系统对于每个直播会写入两份数据，分别为索引和评论数据，索引数据为SortedSet的数据结构用于对评论的排序，而评论数据使用Hashes进行存储，在获取评论的时候通过索引拿到需要的索引id之后通过Hashes的读取来获得评论的列表。评论的写入过程如下：

![][2]

用户在刷新列表之后后台需要获取对应的评论信息，获取的流程如下：  


* 获取当前索引位置
* 获取索引列表
* 获取评论数据



![][3]  

## 菜鸟单据履行中心之订单排序

双11用户在产生一个交易订单之后会随之产生一个物流订单。经过菜鸟仓配系统处理的订单，为了让仓配各个阶段能够更加智能的协同作业，决策系统会根据订单信息指定出对应的订单履行计划，包括什么时候下发仓、什么时候出库、什么时候配送揽收、什么 时候送达等信息，单据履行中心根据履行计划，对每个阶段按照对应的时间去履行物流服务。由于仓、配的运力有限，对于有限的运力下，期望最早作业的单据是业务认为优先级最高的单据，所以订单在真正下发给仓或者配之前，需要按照优先级进行排序。

![][4]

订单履行中心通过使用Redis来对所有的物流订单进行排序决定哪个订单是最高优先级的。  

## 结束

Redis是一个优秀的开源数据库，提供了开发者更便利的数据模型，阿里云Redis致力于提供稳定、高性能的Redis服务，欢迎广大开发者使用[阿里云Redis][5]服务。  


[5]: https://www.aliyun.com/product/kvstore?spm=5176.8142029.388261.36.BOU85T/
[0]: http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/cdae03e0240816e5565bab5ab2f3fd4e.jpg
[1]: http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/aa03d1576ff796f8b02d0d78e817af5c.PNG
[2]: http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/336d64d8ae9c91bafc4da0498f85f7e0.png
[3]: http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/e13ee0e19c2b68405449de452866c439.png
[4]: http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/5e77c5723d208d7252eb0327db07153e.PNG